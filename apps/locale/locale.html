<html>
  <head>
    <meta charset="UTF-8">
    <link rel="stylesheet" href="../../css/spectre.min.css">
    <style>
      table { width:100%;margin:20px;}
      .table_t {font-weight:bold;width:40%;}
      .form-group > * {display:block;}
    </style>
  </head>
  <body>

    <p>Please choose a language from the following list:</p>
    <div class="form-group">
    <select id="languages" class="form-select">
    </select>
    </div>
    <div class="form-group">
      <label><input id="translations" type="checkbox" /> Add common language translations like "Yes", "No", "On", "Off"<br/><i>(Not recommended. For translations use the option under <code>More...</code> in the app loader.</i></label>
      <label><input id="customize" type="checkbox" /> Customize the time and date patterns.</label>
    </div>
    <p>
      <span id="customize-warning"></span>
      <table id="examples-short-long"></table>
      <table id="examples"></table>
    </p>

    <p>Then click <button id="upload" class="btn btn-primary">Upload</button></p>

    <script src="../../core/lib/customize.js"></script>
    <script src="../../core/js/utils.js"></script>
    <script src="locales.js" charset="utf-8"></script>

    <script>
/*
eg. the built-in en_GB at https://github.com/espruino/Espruino/blob/master/libs/js/banglejs/locale.js is:

function round(n, dp) {
  if (dp===undefined) dp=1;
  var p = Math.min(dp,dp - Math.floor(Math.log(n)/Math.log(10)));
  return n.toFixed(p);
}
exports = { name : "system", currencySym:"£",
  translate : str=>str, // as-is
  date : (d,short) => short?("0"+d.getDate()).substr(-2)+"/"+("0"+(d.getMonth()+1)).substr(-2)+"/"+d.getFullYear():d.toString().substr(4,11), // Date to "Feb 28 2020" or "28/02/2020"(short)
  time : (d,short) => { // Date to  "4:15.28 pm" or "15:42"(short)
	  var h = d.getHours(), m = d.getMinutes()
    if ((require('Storage').readJSON('setting.json',1)||{})["12hour"])
      h = (h%12==0) ? 12 : h%12; // 12 hour
    if (short)
      return (" "+h).substr(-2)+":"+("0"+m).substr(-2);
    else {
      var r = "am";
      if (h==0) { h=12; }
      else if (h>=12) {
        if (h>12) h-=12;
        r = "pm";
      }
      return (" "+h).substr(-2)+":"+("0"+m).substr(-2)+"."+("0"+d.getSeconds()).substr(-2)+" "+r;
    }
  },
  dow : (d,short) => "Sunday,Monday,Tuesday,Wednesday,Thursday,Friday,Saturday".split(",")[d.getDay()].substr(0, short ? 3 : 10), // Date to "Monday" or "Mon"(short)
  month : (d,short) => "January,February,March,April,May,June,July,August,September,October,November,December".split(",")[d.getMonth()].substr(0, short ? 3 : 10), // Date to "February" or "Feb"(short)
  number: (n, dec) => {
    if (dec == null) dec = 2;
    var w = n.toFixed(dec),
        k = w|0,
        b = n < 0 ? 1 : 0,
        u = Math.abs(w-k),
        d = (''+u.toFixed(dec)).substr(2, dec),
        s = ''+k,
        i = s.length,
        r = '';
    while ((i-=3) > b)
      r = ',' + s.substr(i, 3) + r;
    return s.substr(0, i + 3) + r + (d ? '.' + d: '');
  },
  currency : n => {console.log("Warning: Currency information is deprecated");return "£"+n.toFixed(2)}, // number to "£1.00"
  distance : (m,dp) => (m<1000)?round(m,dp)+"m":round(m/1000,dp)+"km", // meters to "123m" or "1.2km" depending on size
  speed : (s,dp) => round(s/1.60934,dp)+"mph",// kph to "123mph"
  temp : (t,dp) => round(t,dp)+"'C", // degrees C to degrees C
  meridian: d => (d.getHours() <= 12) ? "am":"pm" // Date to am/pm
};


*/
      function codePageLookup(lang, codePage, ch) {
        var chCode = ch.charCodeAt();
        if (chCode>=32 && chCode<128) return ch; // ASCII - copy it
        // not normal ASCII
        var n; // default is a space
        if (codePage.map.indexOf(ch)>=0)  // look up in char map, escape that
          n = 128+codePage.map.indexOf(ch);
        /*else if (chCode<256) // it's non-ascii, but <256 - just escape it
          n = chCode;*/
        else {
          console.error(`Locale ${lang}: Character ${ch} (${chCode}) is not in Code Page ${codePage.name}`);
          return undefined;
        }
        // escape the char
        return '\\x'+(n+256).toString(16).slice(-2);
      }

      function createLocaleModule() {
        console.log(`Language ${lang}`);

        const translations = document.getElementById('translations').checked;
        console.log(`Translations: ${translations}`);

        if (!locale) {
          alert(`Locale not set for language ${lang}!`);
          return;
        }

        if (!translations)
          locale.trans = null;

        const codePageName = "ISO8859-1";
        if (locale.codePage)
          codePageName = locale.codePage;
        const codePage = codePages[codePageName];
        if (!codePage) {
          alert(`Code Page ${codePageName} not found!`);
          return;
        }

        // Convert object to JSON, with codepage
        function js(x) {
          // do nortmal conversion
          x = JSON.stringify(x);
          /* assume any out of bounds character is going to
          be inside a quoted string */
          var s = '';
          for (var i=0;i<x.length;i++) {
            var ch = codePageLookup(lang, codePage, x[i]);
            s += (ch===undefined) ? "?" : ch;
          }
          return s;
        }

        function unitConv(x) {
          return x === 1 ? 'n' : 'n/' + x
        }

        var replaceList  = {
          "%Y":  "d.getFullYear()",
          "%y":  "d.getFullYear().toString().slice(-2)",
          "%m":  "('0'+(d.getMonth()+1).toString()).slice(-2)",
          "%-m": "d.getMonth()+1",
          "%d":  "('0'+d.getDate()).slice(-2)",
          "%-d": "d.getDate()",
          "%HH": "getHours(d)",
          "%MM": "('0'+d.getMinutes()).slice(-2)",
          "%SS": "('0'+d.getSeconds()).slice(-2)",
          "%A":  `${js(locale.day)}.split(',')[d.getDay()]`,
          "%a":  `${js(locale.abday)}.split(',')[d.getDay()]`,
          "%B":  `${js(locale.month)}.split(',')[d.getMonth()]`,
          "%b":  `${js(locale.abmonth)}.split(',')[d.getMonth()]`,
          "%p":  `d.getHours()<12?${js(locale.ampm[0].toUpperCase())}:${js(locale.ampm[1].toUpperCase())}`,
          "%P":  `d.getHours()<12?${js(locale.ampm[0].toLowerCase())}:${js(locale.ampm[1].toLowerCase())}`
        };

        var timeN = locale.timePattern[0];
        var timeS = locale.timePattern[1];
        var dateN = locale.datePattern[0];
        var dateS = locale.datePattern[1];
        Object.keys(replaceList).forEach(e => {
          timeN = timeN.replace(e,"${"+replaceList[e]+"}");
          timeS = timeS.replace(e,"${"+replaceList[e]+"}");
          dateN = dateN.replace(e,"${"+replaceList[e]+"}");
          dateS = dateS.replace(e,"${"+replaceList[e]+"}");
        });
        var temperature = locale.temperature=='°F' ? '(t*9/5)+32' : 't';

        function getLocaleModule(isLocal) {
          return `
function round(n, dp) {
  if (dp===undefined) dp=0;
  var p = Math.max(0,Math.min(dp,dp - Math.floor(Math.log(n)/Math.log(10))));
  return n.toFixed(p);
}
var is12;
function getHours(d) {
  var h = d.getHours();
  if (is12 === undefined) is12 = ${isLocal ? "false" : `(require('Storage').readJSON('setting.json', 1) || {})["12hour"]`};
  if (!is12) return ('0' + h).slice(-2);
  return ((h % 12 == 0) ? 12 : h % 12).toString();
}
exports = {
  name: ${js(locale.lang)},
  currencySym: ${js("£")},
  dow: (d,short) => ${js(locale.day + ',' + locale.abday)}.split(',')[d.getDay() + (short ? 7 : 0)],
  month: (d,short) => ${js(locale.month + ',' + locale.abmonth)}.split(',')[d.getMonth() + (short ? 12 : 0)],
  number: (n, dec) => {
    if (dec == null) dec = 2;
    var w = n.toFixed(dec),
        k = w|0,
        b = n < 0 ? 1 : 0,
        u = Math.abs(w-k),
        d = (''+u.toFixed(dec)).substr(2, dec),
        s = ''+k,
        i = s.length,
        r = '';
    while ((i-=3) > b)
      r = '${locale.thousands_sep}' + s.substr(i, 3) + r;
    return s.substr(0, i + 3) + r + (d ? '${locale.decimal_point}' + d: '');
  },
  currency: n => {console.log("Warning: Currency information is deprecated, see https://github.com/espruino/BangleApps/issues/3269");return ${js("£")}+exports.number(n)},
  distance: (n,dp) => n < ${distanceUnits[locale.distance[1]]} ? round(${unitConv(distanceUnits[locale.distance[0]])},dp) + ${js(locale.distance[0])} : round(${unitConv(distanceUnits[locale.distance[1]])},dp) + ${js(locale.distance[1])},
  speed: (n,dp) => round(${unitConv(speedUnits[locale.speed])},dp) + ${js(locale.speed)},
  temp: (t,dp) => round(${temperature},dp) + ${js(locale.temperature)},
  translate: s => ${locale.trans?`{var t=${js(locale.trans)};s=''+s;return t[s]||t[s.toLowerCase()]||s;}`:`s`},
  date: (d,short) => short ? \`${dateS}\` : \`${dateN}\`,
  time: (d,short) => short ? \`${timeS}\` : \`${timeN}\`,
  meridian: d => d.getHours() < 12 ? ${js(locale.ampm[0])}:${js(locale.ampm[1])},
};
`.trim()
        };

        var exports;
        eval(getLocaleModule(true));
        console.log("exports:",exports);

        function patternOutput(pattern){
          Object.keys(replaceList).forEach(e => {
            pattern = pattern.replace(e,"${"+replaceList[e]+"}");
          });
          pattern = eval(`let d = new Date();\`${pattern}\``);
          return pattern;
        }
        function dataList(id, options, formatter){
          let output = `<datalist id="${id}">`;
            for(const option of options){
              let formatted = option;
              formatted = formatter?.(formatted) || formatted;
              output+=`\n<option value="${option}">${formatted}</option>`
            }
          output += "\n</datalist>";
          return output;
        }

        var date = new Date();
        // TODO: This warning should have a link to an article explaining how the formats work, and how long they are allowed to be
        document.getElementById("customize-warning").innerText = customizeLocale ? "⚠️ If you make the formats too long, some apps will not work!" : "";
        document.getElementById("examples-short-long").innerHTML = `
<tr><td class="table_t"></td><td style="font-weight:bold">Short</td><td style="font-weight:bold">Long</td></tr>
<tr><td class="table_t">Day</td><td>${exports.dow(date,1)}</td><td>${exports.dow(date,0)}</td></tr>
<tr><td class="table_t">Month</td><td>${exports.month(date,1)}</td><td>${exports.month(date,0)}</td></tr>
${customizeLocale ? `<tr><td class="table_t">Date Pattern</td>
    <td>
      <input type=text id="short-date-pattern" list="short-date-patterns" value="${locale?.datePattern["1"]}"/>
      ${dataList("short-date-patterns", datePatterns["1"], patternOutput)}
    </td>
    <td>
      <input type=text id="long-date-pattern" list="long-date-patterns" value="${locale?.datePattern["0"]}"/>
      ${dataList("long-date-patterns", datePatterns["0"], patternOutput)}
    </td>
    </td>`
  : ""}
<tr><td class="table_t">Date</td>
  <td id="short-date-pattern-output">${exports.date(date,1)}</td>
  <td id="long-date-pattern-output">${exports.date(date,0)}</td>
</tr>
${customizeLocale ? `<tr><td class="table_t">Time Pattern</td>
    <td>
      <input type=text id="short-time-pattern" list="short-time-patterns" value="${locale?.timePattern["1"]}"/>
      ${dataList("short-time-patterns", timePatterns["1"], patternOutput)}
    </td>
    <td>
      <input type=text id="long-time-pattern" list="long-time-patterns" value="${locale?.timePattern["0"]}"/>
      ${dataList("long-time-patterns", timePatterns["0"], patternOutput)}
    </td>
    </td>`
  : ""}
<tr><td class="table_t">Time</td>
  <td id="short-time-pattern-output">${exports.time(date,1)}</td>
  <td id="long-time-pattern-output">${exports.time(date,0)}</td>
</tr>
  <tr><td class="table_t">Number</td><td>${exports.number(12.3456789)}</td><td>${exports.number(12.3456789,4)}</td></tr>
  <tr><td class="table_t">Distance</td><td>${exports.distance(12.34,0)}</td><td>${exports.distance(12345.6,1)}</td></tr>
`;
document.getElementById("examples").innerHTML = `
<tr><td class="table_t"></td><td style="font-weight:bold">Value</td></tr>
${customizeLocale ? `<tr><td class="table_t">Meridian format</td>
    <td>
      <input type=text id="meridian-am" list="meridian-ams" value="${locale?.ampm["0"]}"/>
      ${dataList("meridian-ams", meridians["0"])}
    </td>
    <td>
      <input type=text id="meridian-pm" list="meridian-pms" value="${locale?.ampm["1"]}"/>
      ${dataList("meridian-pms", meridians["1"])}
    </td>
    </tr>`
  : ""}
<tr><td class="table_t">Meridian</td><td>
  <span id="meridian-am-output">${exports.meridian(new Date(0))}</span> /
  <span id="meridian-pm-output">${exports.meridian(new Date(43200000))}</span>
</td></tr>
<tr><td class="table_t">Speed</td><td>${exports.speed(123)}</td></tr>
<tr><td class="table_t">Temperature</td><td>${exports.temp(12,0)}</td></tr>
`;

        if(customizeLocale){
          document.querySelector("input#short-date-pattern").addEventListener("input", event => {
            locale.datePattern["1"] = event.target.value;
            document.querySelector("td#short-date-pattern-output").innerText = patternOutput(event.target.value);
          });
          document.querySelector("input#long-date-pattern").addEventListener("input", event => {
            locale.datePattern["0"] = event.target.value;
            document.querySelector("td#long-date-pattern-output").innerText = patternOutput(event.target.value);
          });
          document.querySelector("input#short-time-pattern").addEventListener("input", event => {
            locale.timePattern["1"] = event.target.value;
            document.querySelector("td#short-time-pattern-output").innerText = patternOutput(event.target.value);
          });
          document.querySelector("input#long-time-pattern").addEventListener("input", event => {
            locale.timePattern["0"] = event.target.value;
            document.querySelector("td#long-time-pattern-output").innerText = patternOutput(event.target.value);
          });
          document.querySelector("input#meridian-am").addEventListener("input", event => {
            locale.ampm["0"] = event.target.value;
            document.querySelector("span#meridian-am-output").innerText = patternOutput(event.target.value);
          });
          document.querySelector("input#meridian-pm").addEventListener("input", event => {
            locale.ampm["1"] = event.target.value;
            document.querySelector("span#meridian-pm-output").innerText = patternOutput(event.target.value);
          });
        }
        return getLocaleModule(false);
      }

      var lang;
      var locale;
      var customizeLocale;
      var languageSelector = document.getElementById("languages");
      var customizeSelector = document.getElementById('customize');
      languageSelector.innerHTML = Object.keys(locales).map(l=>{
        var locale = locales[l];
        var localeParts = l.split("_"); // en_GB -> ["en","GB"]
        var icon = "";
        // If we have a 2 char ISO country code, use it to get the unicode flag
        if (locale.icon)
          icon = locale.icon+" ";
        else if (localeParts[1] && localeParts[1].length==2)
          icon = localeParts[1].toUpperCase().replace(/./g, char => String.fromCodePoint(char.charCodeAt(0)+127397) )+" ";
        return `<option value="${l}">${icon}${l}${locale.notes?" - "+locale.notes:""}</option>`
      }).join("\n");
      languageSelector.addEventListener('change', function() {
        lang = languageSelector.options[languageSelector.selectedIndex].value;
        locale = locales[lang]
        createLocaleModule();
      });
      customizeSelector.addEventListener('change', function() {
        customizeLocale = customizeSelector.checked;
        createLocaleModule();
      });
      // initial value
      lang = languageSelector.options[languageSelector.selectedIndex].value;
      locale = locales[lang];
      customizeLocale = false;
      createLocaleModule();



      document.getElementById("upload").addEventListener("click", function() {

        var localeModule = createLocaleModule(lang);

        console.log("Locale Module is:",localeModule);
        sendCustomizedApp({
          storage:[
            {name:"locale", url:"locale.js", content:localeModule}
          ]
        });
      });
    </script>
  </body>
</html>
